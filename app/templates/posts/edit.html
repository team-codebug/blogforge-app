{% extends 'layout.html' %}
{% block title %}{{ 'Edit Post ¬∑ BlogForge' if post else 'New Post ¬∑ BlogForge' }}{% endblock %}
{% block content %}
<div class='flex flex-col gap-4'>
	<div class='flex items-center justify-between'>
		<h1 class='text-xl md:text-2xl font-semibold'>{{ 'Edit Post' if post else 'New Post' }}</h1>
		<div class='flex items-center gap-2'>
			<button type='button' id='aiLinkedIn' class='px-3 py-2 rounded-md bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-soft hover:shadow-lg transition'>‚ú® Repurpose to LinkedIn</button>
			<button type='button' id='aiTwitter' class='px-3 py-2 rounded-md border border-purple-600/40 text-purple-700 dark:text-purple-300 hover:bg-purple-50 dark:hover:bg-purple-950/20 transition'>üê¶ Generate Tweet Thread</button>
			<button type='button' id='aiSummary' class='px-3 py-2 rounded-md border border-indigo-600/40 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-50 dark:hover:bg-indigo-950/20 transition'>üß† Summarize</button>
		</div>
	</div>
	<form method='post' action='{{ url_for('posts.update_post', post_id=post.id) if post else url_for('posts.create_post') }}' class='space-y-4'>
		<input type='text' name='title' value='{{ post.title if post else '' }}' placeholder='Post title' class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft outline-none focus:ring-2 focus:ring-purple-600/30'>
		<div class='grid grid-cols-1 lg:grid-cols-2 gap-4'>
			<textarea id='mdInput' name='content' rows='22' class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft outline-none focus:ring-2 focus:ring-indigo-600/30' placeholder='Write markdown here...'>{{ post.content_markdown if post else '' }}</textarea>
			<div class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft'>
				<div class='text-slate-500 text-sm mb-2'>Live Preview</div>
				<article id='mdPreview' class='prose prose-slate dark:prose-invert max-w-none'></article>
			</div>
		</div>
		<div class='flex items-center gap-2'>
			<button class='px-4 py-2 rounded-md bg-slate-900 text-white dark:bg-white dark:text-slate-900'>Save</button>
			<a class='px-4 py-2 rounded-md border border-slate-300 dark:border-slate-700' href='{{ url_for('posts.list_posts') }}'>Cancel</a>
		</div>
	</form>
	<!-- AI Output Drawer -->
	<div id='aiOutput' class='hidden border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft'>
		<div class='text-slate-500 text-sm mb-2'>AI Output</div>
		<pre class='whitespace-pre-wrap text-sm' id='aiOutputContent'></pre>
	</div>
</div>

<script src='{{ url_for('static', filename='js/editor.js') }}'></script>
<script>
	window.addEventListener('DOMContentLoaded', function(){
		const mdIn = document.getElementById('mdInput');
		const mdPrev = document.getElementById('mdPreview');
		function render() {
			// naive markdown preview for now; replace with server/client renderer later
			const txt = mdIn.value;
			mdPrev.innerHTML = txt
				.replace(/\n\n/g, '<br/><br/>')
				.replace(/^# (.*$)/gim, '<h1>$1</h1>')
				.replace(/^## (.*$)/gim, '<h2>$1</h2>')
				.replace(/^### (.*$)/gim, '<h3>$1</h3>')
				.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
				.replace(/\*(.*?)\*/g, '<em>$1</em>');
		}
		mdIn.addEventListener('input', render);
		render();

		const out = document.getElementById('aiOutput');
		const outC = document.getElementById('aiOutputContent');
		async function call(path) {
			out.classList.remove('hidden');
			outC.textContent = 'Working...';
			try {
				const res = await fetch(path, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({ post_id: {{ post.id if post else 'null' }} })
				});
				const data = await res.json();
				outC.textContent = JSON.stringify(data, null, 2);
			} catch (e) {
				outC.textContent = 'Error calling AI service';
			}
		}
		document.getElementById('aiLinkedIn').addEventListener('click', function(){ call('/api/ai/blog-to-linkedin'); });
		document.getElementById('aiTwitter').addEventListener('click', function(){ call('/api/ai/blog-to-twitter-thread'); });
		document.getElementById('aiSummary').addEventListener('click', function(){ call('/api/ai/summarize'); });
	});
</script>
{% endblock %}
