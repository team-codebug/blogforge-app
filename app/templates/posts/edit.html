{% extends 'layout.html' %}
{% block title %}{{ 'Edit Post ¬∑ BlogForge' if blog else 'New Post ¬∑ BlogForge' }}{% endblock %}
{% block content %}
<div class='flex flex-col gap-4'>
	<div class='flex items-center justify-between'>
		<h1 class='text-xl md:text-2xl font-semibold'>{{ 'Edit Post' if blog else 'New Post' }}</h1>
		{% if blog %}
		<div class='flex items-center gap-2'>
			<button type='button' id='aiLinkedIn' class='px-3 py-2 rounded-md bg-orange-500 text-white shadow-soft hover:bg-orange-600 hover:shadow-lg transition'>‚ú® Repurpose to LinkedIn</button>
			<button type='button' id='aiTwitter' class='px-3 py-2 rounded-md bg-orange-500 text-white shadow-soft hover:bg-orange-600 hover:shadow-lg transition'>üê¶ Generate Tweet Thread</button>
			<!-- <button type='button' id='aiSummary' class='px-3 py-2 rounded-md bg-orange-500 text-white shadow-soft hover:bg-orange-600 hover:shadow-lg transition'>üß† Summarize</button> -->
		</div>
		{% endif %}
	</div>
	<form method='post' action='{{ url_for('posts.update_blog', blog_id=blog.id) if blog else url_for('posts.create_blog') }}' class='space-y-4' data-blog-id='{{ blog.id if blog else "" }}'>
		<input type='hidden' name='csrf_token' value='{{ csrf_token() }}'>
		<input type='text' name='title' value='{{ blog.title if blog else '' }}' placeholder='Blog title' class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft outline-none focus:ring-2 focus:ring-orange-500/30'>
		
		<!-- Description Field -->
		<div class='space-y-2'>
			<div class='flex items-center justify-between'>
				<label class='text-sm font-medium text-slate-700 dark:text-slate-300'>Description</label>
				<div class='flex items-center gap-2'>
					<span id='descriptionWordCount' class='text-xs text-slate-500'>0/50 words</span>
					<button type='button' id='generateDescription' class='px-3 py-1 text-xs rounded-md bg-orange-500 text-white hover:bg-orange-600 hover:shadow-lg transition'>‚ú® Generate with AI</button>
				</div>
			</div>
			<textarea id='descriptionInput' name='description' rows='2' maxlength='500' placeholder='Brief description of your blog post (max 50 words)...' class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft outline-none focus:ring-2 focus:ring-orange-500/30 text-sm resize-none'>{{ blog.description if blog else '' }}</textarea>
		</div>
		
		<!-- Tag Selection (only show when editing existing post) -->
		{% if blog and available_tags %}
		<div class='space-y-2'>
			<label class='text-sm font-medium text-slate-700 dark:text-slate-300'>Tags</label>
			<div class='flex flex-wrap gap-2'>
				{% for tag in available_tags %}
				<label class='flex items-center gap-2 px-3 py-1 rounded-full border border-slate-300 dark:border-slate-600 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors'>
					<input type='checkbox' name='tags' value='{{ tag.id }}' 
						   {% if tag.id in current_tag_ids %}checked{% endif %}
						   class='rounded border-slate-300 text-orange-600 focus:ring-orange-500'>
					<span class='text-sm text-slate-700 dark:text-slate-300'>{{ tag.name }}</span>
				</label>
				{% endfor %}
			</div>
			{% if not available_tags %}
			<p class='text-sm text-slate-500'>No tags available. <a href='{{ url_for('posts.list_tags') }}' class='text-orange-600 hover:text-orange-700'>Create some tags first</a>.</p>
			{% endif %}
		</div>
		{% endif %}
		
		<div class='grid grid-cols-1 lg:grid-cols-2 gap-4'>
			<div class='space-y-2'>
				<div class='flex items-center justify-between'>
					<label class='text-sm font-medium text-slate-700'>Editor</label>
					<div class='flex items-center gap-2 text-xs text-slate-500'>
						<span id='wordCount'>0 words</span>
						<span id='saveStatus' class='text-green-600'>Saved</span>
					</div>
				</div>
				<textarea id='mdInput' name='content' rows='22' class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft outline-none focus:ring-2 focus:ring-indigo-600/30 font-mono text-sm' placeholder='Write markdown here...'>{{ blog.content_markdown if blog else '' }}</textarea>
			</div>
			<div class='space-y-2'>
				<div class='flex items-center justify-between'>
					<label class='text-sm font-medium text-slate-700'>Preview</label>
					<button type='button' id='togglePreview' class='text-xs text-slate-500 hover:text-slate-700'>Fullscreen</button>
				</div>
			<div class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft min-h-[400px] overflow-y-auto'>
				<article id='mdPreview' class='prose max-w-none'></article>
			</div>
			</div>
		</div>
		<div class='flex items-center gap-2'>
			<button class='px-4 py-2 rounded-md bg-slate-900 text-white dark:bg-white dark:text-slate-900'>Save</button>
			<button type='button' id='cancelButton' class='px-4 py-2 rounded-md border border-slate-300 dark:border-slate-700'>Cancel</button>
		</div>
	</form>
	
	<!-- Social Media Content Display (only show when editing existing post) -->
	{% if blog %}
	<div class='mt-8 space-y-6'>
		<!-- LinkedIn Content -->
		{% if blog.linkedin_content %}
		<div class='bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4'>
			<div class='flex items-center justify-between mb-3'>
				<h3 class='text-lg font-semibold text-blue-900 dark:text-blue-100 flex items-center gap-2'>
					<svg class='w-5 h-5' fill='currentColor' viewBox='0 0 24 24'><path d='M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z'/></svg>
					LinkedIn Post
				</h3>
				<button type='button' onclick='regenerateLinkedIn()' class='text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200'>Regenerate</button>
			</div>
			<div class='bg-white dark:bg-slate-900 rounded-md p-4 border border-blue-200 dark:border-blue-700'>
				<p class='text-slate-800 dark:text-slate-200 whitespace-pre-wrap'>{{ blog.linkedin_content }}</p>
			</div>
		</div>
		{% endif %}
		
		<!-- Twitter Thread -->
		{% if blog.twitter_thread %}
		<div class='bg-sky-50 dark:bg-sky-950/20 border border-sky-200 dark:border-sky-800 rounded-lg p-4'>
			<div class='flex items-center justify-between mb-3'>
				<h3 class='text-lg font-semibold text-sky-900 dark:text-sky-100 flex items-center gap-2'>
					<svg class='w-5 h-5' fill='currentColor' viewBox='0 0 24 24'><path d='M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z'/></svg>
					Twitter Thread
				</h3>
				<button type='button' onclick='regenerateTwitter()' class='text-sm text-sky-600 hover:text-sky-800 dark:text-sky-400 dark:hover:text-sky-200'>Regenerate</button>
			</div>
			<div class='space-y-3'>
				{% set twitter_tweets = blog.twitter_thread | from_json %}
				{% for tweet in twitter_tweets %}
				<div class='bg-white dark:bg-slate-900 rounded-md p-4 border border-sky-200 dark:border-sky-700'>
					<p class='text-slate-800 dark:text-slate-200'>{{ tweet }}</p>
				</div>
				{% endfor %}
			</div>
		</div>
		{% endif %}
	</div>
	{% endif %}
	
	<!-- AI Output Drawer -->
	<div id='aiOutput' class='hidden border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft'>
		<div class='text-slate-500 text-sm mb-2'>AI Output</div>
		<pre class='whitespace-pre-wrap text-sm' id='aiOutputContent'></pre>
	</div>
</div>

<!-- Draft Confirmation Modal -->
<div id='draftModal' class='fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center p-4' style='position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important;'>
	<div class='bg-white rounded-lg max-w-sm w-full shadow-2xl'>
		<div id="draftModalContent" class='p-8'>
			<div class='flex items-center gap-4 mb-6'>
				<div class='w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center'>
					<svg class='w-5 h-5 text-yellow-600' fill='currentColor' viewBox='0 0 20 20'>
						<path fill-rule='evenodd' d='M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z' clip-rule='evenodd'/>
					</svg>
				</div>
				<h3 class='text-xl font-semibold text-slate-800'>Save as Draft?</h3>
			</div>
			<p class='text-slate-600 mb-8 text-base leading-relaxed'>You have unsaved changes. Would you like to save this post as a draft before leaving?</p>
			<div class='flex flex-col sm:flex-row gap-3 justify-end'>
				<button id='continueEditingBtn' class='px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors text-sm'>
					Continue Editing
				</button>
				<button id='discardChangesBtn' class='px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-sm'>
					Discard Changes
				</button>
				<button id='saveDraftBtn' class='px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors text-sm font-medium'>
					Save as Draft
				</button>
			</div>
		</div>
	</div>
</div>

<script src='{{ url_for('static', filename='js/editor.js') }}'></script>
<script>
	window.addEventListener('DOMContentLoaded', function(){
		const mdIn = document.getElementById('mdInput');
		const mdPrev = document.getElementById('mdPreview');
		
		// Get blog ID from form data attribute
		const form = document.querySelector('form[data-blog-id]');
		const blogId = form ? form.getAttribute('data-blog-id') : null;
		
		// Function to update LinkedIn content in the UI
		function updateLinkedInContent(content) {
			// Find or create the social media content section
			let socialSection = document.querySelector('.mt-8.space-y-6');
			if (!socialSection) {
				// Create the social media section if it doesn't exist
				socialSection = document.createElement('div');
				socialSection.className = 'mt-8 space-y-6';
				document.querySelector('.flex.flex-col.gap-4').appendChild(socialSection);
			}
			
			// Check if LinkedIn content section already exists
			let linkedinSection = document.querySelector('.bg-blue-50');
			if (!linkedinSection) {
				// Create LinkedIn content section
				linkedinSection = document.createElement('div');
				linkedinSection.className = 'bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4';
				linkedinSection.innerHTML = `
					<div class='flex items-center justify-between mb-3'>
						<h3 class='text-lg font-semibold text-blue-900 dark:text-blue-100 flex items-center gap-2'>
							<svg class='w-5 h-5' fill='currentColor' viewBox='0 0 24 24'><path d='M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z'/></svg>
							LinkedIn Post
						</h3>
						<button type='button' onclick='regenerateLinkedIn()' class='text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200'>Regenerate</button>
					</div>
					<div class='bg-white dark:bg-slate-900 rounded-md p-4 border border-blue-200 dark:border-blue-700'>
						<p class='text-slate-800 dark:text-slate-200 whitespace-pre-wrap'>${content}</p>
					</div>
				`;
				socialSection.appendChild(linkedinSection);
			} else {
				// Update existing LinkedIn content
				const contentParagraph = linkedinSection.querySelector('p');
				if (contentParagraph) {
					contentParagraph.textContent = content;
				}
			}
		}
		
		// Function to update Twitter content in the UI
		function updateTwitterContent(content) {
			// Find or create the social media content section
			let socialSection = document.querySelector('.mt-8.space-y-6');
			if (!socialSection) {
				// Create the social media section if it doesn't exist
				socialSection = document.createElement('div');
				socialSection.className = 'mt-8 space-y-6';
				document.querySelector('.flex.flex-col.gap-4').appendChild(socialSection);
			}
			
			// Check if Twitter content section already exists
			let twitterSection = document.querySelector('.bg-sky-50');
			if (!twitterSection) {
				// Create Twitter content section
				twitterSection = document.createElement('div');
				twitterSection.className = 'bg-sky-50 dark:bg-sky-950/20 border border-sky-200 dark:border-sky-800 rounded-lg p-4';
				twitterSection.innerHTML = `
					<div class='flex items-center justify-between mb-3'>
						<h3 class='text-lg font-semibold text-sky-900 dark:text-sky-100 flex items-center gap-2'>
							<svg class='w-5 h-5' fill='currentColor' viewBox='0 0 24 24'><path d='M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z'/></svg>
							Twitter Thread
						</h3>
						<button type='button' onclick='regenerateTwitter()' class='text-sm text-sky-600 hover:text-sky-800 dark:text-sky-400 dark:hover:text-sky-200'>Regenerate</button>
					</div>
					<div class='bg-white dark:bg-slate-900 rounded-md p-4 border border-sky-200 dark:border-sky-700'>
						<div class='text-slate-800 dark:text-slate-200 whitespace-pre-wrap'>${content}</div>
					</div>
				`;
				socialSection.appendChild(twitterSection);
			} else {
				// Update existing Twitter content
				const contentDiv = twitterSection.querySelector('div.text-slate-800');
				if (contentDiv) {
					contentDiv.textContent = content;
				}
			}
		}
		
		function render() {
			// naive markdown preview for now; replace with server/client renderer later
			const txt = mdIn.value;
			mdPrev.innerHTML = txt
				.replace(/\n\n/g, '<br/><br/>')
				.replace(/^# (.*$)/gim, '<h1>$1</h1>')
				.replace(/^## (.*$)/gim, '<h2>$1</h2>')
				.replace(/^### (.*$)/gim, '<h3>$1</h3>')
				.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
				.replace(/\*(.*?)\*/g, '<em>$1</em>');
		}
		mdIn.addEventListener('input', render);
		render();

		const out = document.getElementById('aiOutput');
		const outC = document.getElementById('aiOutputContent');
		async function call(path) {
			out.classList.remove('hidden');
			outC.textContent = 'Working...';
			try {
				const res = await fetch(path, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({ blog_id: {{ blog.id if blog else 'null' }} })
				});
				const data = await res.json();
				outC.textContent = JSON.stringify(data, null, 2);
			} catch (e) {
				outC.textContent = 'Error calling AI service';
			}
		}
		// AI buttons (only available when editing existing blog)
		const aiLinkedInBtn = document.getElementById('aiLinkedIn');
		const aiTwitterBtn = document.getElementById('aiTwitter');
		const aiSummaryBtn = document.getElementById('aiSummary');
		
		if (aiLinkedInBtn) {
			aiLinkedInBtn.addEventListener('click', async function() {
				const button = this;
				const originalText = button.textContent;
				button.textContent = 'Generating...';
				button.disabled = true;
				
				try {
					const blogId = document.querySelector('form[data-blog-id]').getAttribute('data-blog-id');
					const response = await fetch('/api/ai/blog-to-linkedin', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
						},
						body: JSON.stringify({ blog_id: parseInt(blogId) })
					});
					
					const data = await response.json();
					if (data.linkedin_content) {
						// Show success message and update the page content
						alert('LinkedIn content generated successfully!');
						
						// Create or update the LinkedIn content section
						updateLinkedInContent(data.linkedin_content);
					} else {
						alert('Failed to generate LinkedIn content');
					}
				} catch (error) {
					console.error('Error generating LinkedIn content:', error);
					alert('Error generating LinkedIn content');
				} finally {
					button.textContent = originalText;
					button.disabled = false;
				}
			});
		}
		if (aiTwitterBtn) {
			aiTwitterBtn.addEventListener('click', async function() {
				const button = this;
				const originalText = button.textContent;
				button.textContent = 'Generating...';
				button.disabled = true;
				
				try {
					const blogId = document.querySelector('form[data-blog-id]').getAttribute('data-blog-id');
					const response = await fetch('/api/ai/blog-to-twitter-thread', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
						},
						body: JSON.stringify({ blog_id: parseInt(blogId) })
					});
					
					const data = await response.json();
					if (data.twitter_thread) {
						// Show success message and update the page content
						alert('Twitter thread generated successfully!');
						
						// Create or update the Twitter content section
						updateTwitterContent(data.twitter_thread);
					} else {
						alert('Failed to generate Twitter thread');
					}
				} catch (error) {
					console.error('Error generating Twitter thread:', error);
					alert('Error generating Twitter thread');
				} finally {
					button.textContent = originalText;
					button.disabled = false;
				}
			});
		}
		if (aiSummaryBtn) {
			aiSummaryBtn.addEventListener('click', function(){ call('/api/ai/summarize'); });
		}
		
		// Description functionality
		console.log('Looking for description elements...');
		const descInput = document.getElementById('descriptionInput');
		const descWordCount = document.getElementById('descriptionWordCount');
		const generateDescBtn = document.getElementById('generateDescription');
		
		console.log('Description input found:', descInput);
		console.log('Description word count found:', descWordCount);
		console.log('Generate description button found:', generateDescBtn);
		
		if (!generateDescBtn) {
			console.error('Generate description button not found!');
			alert('Generate description button not found!');
			return;
		}
		
		function updateDescriptionWordCount() {
			const text = descInput.value;
			const words = text.trim() ? text.trim().split(/\s+/).length : 0;
			descWordCount.textContent = `${words}/50 words`;
			descWordCount.className = words > 50 ? 'text-xs text-red-500' : 'text-xs text-slate-500';
		}
		
		descInput.addEventListener('input', updateDescriptionWordCount);
		updateDescriptionWordCount();
		
		generateDescBtn.addEventListener('click', async function() {
			console.log('Generate description button clicked');
			const title = document.querySelector('input[name="title"]').value;
			const content = mdIn.value;
			
			console.log('Title:', title);
			console.log('Content:', content);
			
			if (!title && !content) {
				alert('Please add a title or content before generating description');
				return;
			}
			
			generateDescBtn.textContent = 'Generating...';
			generateDescBtn.disabled = true;
			
			try {
				const response = await fetch('/api/ai/generate-description', {
					method: 'POST',
					headers: { 
						'Content-Type': 'application/json',
						'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
					},
					body: JSON.stringify({ 
						title: title,
						content: content
					})
				});
				
				const data = await response.json();
				if (data.description) {
					descInput.value = data.description;
					updateDescriptionWordCount();
				} else {
					alert('Failed to generate description');
				}
			} catch (error) {
				console.error('Error generating description:', error);
				alert('Error generating description');
			} finally {
				generateDescBtn.textContent = '‚ú® Generate with AI';
				generateDescBtn.disabled = false;
			}
		});
		
		// Tag selection enhancement
		const tagCheckboxes = document.querySelectorAll('input[name="tags"]');
		tagCheckboxes.forEach(checkbox => {
			checkbox.addEventListener('change', function() {
				const label = this.closest('label');
				if (this.checked) {
					label.classList.add('bg-orange-100', 'border-orange-400', 'dark:bg-orange-900/20', 'dark:border-orange-500');
					label.classList.remove('hover:bg-slate-50', 'dark:hover:bg-slate-800');
				} else {
					label.classList.remove('bg-orange-100', 'border-orange-400', 'dark:bg-orange-900/20', 'dark:border-orange-500');
					label.classList.add('hover:bg-slate-50', 'dark:hover:bg-slate-800');
				}
			});
			
			// Initialize visual state
			if (checkbox.checked) {
				const label = checkbox.closest('label');
				label.classList.add('bg-orange-100', 'border-orange-400', 'dark:bg-orange-900/20', 'dark:border-orange-500');
				label.classList.remove('hover:bg-slate-50', 'dark:hover:bg-slate-800');
			}
		});
		
		// Draft modal functionality
		const cancelButton = document.getElementById('cancelButton');
		const draftModal = document.getElementById('draftModal');
		const saveDraftBtn = document.getElementById('saveDraftBtn');
		const discardChangesBtn = document.getElementById('discardChangesBtn');
		const continueEditingBtn = document.getElementById('continueEditingBtn');
		
		// Check if we're creating a new post (not editing existing)
		const isNewPost = !document.querySelector('form[data-blog-id]').getAttribute('data-blog-id');
		
		cancelButton.addEventListener('click', function() {
			if (isNewPost) {
				// Show draft modal for new posts
				draftModal.classList.remove('hidden');
			} else {
				// For existing posts, just redirect
				window.location.href = '{{ url_for('posts.list_blogs') }}';
			}
		});
		
		// Save as draft
		saveDraftBtn.addEventListener('click', async function() {
			const title = document.querySelector('input[name="title"]').value;
			const description = document.querySelector('textarea[name="description"]').value;
			const content = mdIn.value;
			
			if (!title.trim()) {
				alert('Please enter a title before saving as draft');
				return;
			}
			
			try {
				const response = await fetch('/posts/save-draft', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
					},
				body: JSON.stringify({
					blog_id: blogId,
					title: title,
					description: description,
					content: content
				})
				});
				
				const data = await response.json();
				if (data.success) {
					window.location.href = '{{ url_for('posts.list_blogs') }}';
				} else {
					alert('Failed to save draft: ' + data.error);
				}
			} catch (error) {
				console.error('Error saving draft:', error);
				alert('Error saving draft');
			}
		});
		
		// Discard changes
		discardChangesBtn.addEventListener('click', function() {
			window.location.href = '{{ url_for('posts.list_blogs') }}';
		});
		
		// Continue editing
		continueEditingBtn.addEventListener('click', function() {
			draftModal.classList.add('hidden');
		});
	});
	
	
	// Regenerate functions
	window.regenerateLinkedIn = async function() {
		const button = event.target;
		const originalText = button.textContent;
		button.textContent = 'Regenerating...';
		button.disabled = true;
		
		try {
			const blogId = document.querySelector('form[data-blog-id]').getAttribute('data-blog-id');
			const response = await fetch('/api/ai/blog-to-linkedin', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
				},
				body: JSON.stringify({ blog_id: parseInt(blogId) })
			});
			
			const data = await response.json();
			if (data.linkedin_content) {
				window.location.reload();
			} else {
				alert('Error regenerating LinkedIn content');
			}
		} catch (error) {
			console.error('Error regenerating LinkedIn content:', error);
			alert('Error regenerating LinkedIn content');
		} finally {
			button.textContent = originalText;
			button.disabled = false;
		}
	};
	
	window.regenerateTwitter = async function() {
		const button = event.target;
		const originalText = button.textContent;
		button.textContent = 'Regenerating...';
		button.disabled = true;
		
		try {
			const blogId = document.querySelector('form[data-blog-id]').getAttribute('data-blog-id');
			const response = await fetch('/api/ai/blog-to-twitter-thread', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
				},
				body: JSON.stringify({ blog_id: parseInt(blogId) })
			});
			
			const data = await response.json();
			if (data.twitter_thread) {
				window.location.reload();
			} else {
				alert('Error regenerating Twitter thread');
			}
		} catch (error) {
			console.error('Error regenerating Twitter thread:', error);
			alert('Error regenerating Twitter thread');
		} finally {
			button.textContent = originalText;
			button.disabled = false;
		}
	};
</script>

<style>
/* Ensure draft modal appears above everything */
#draftModal {
	position: fixed !important;
	top: 0 !important;
	left: 0 !important;
	width: 100vw !important;
	height: 100vh !important;
	z-index: 9999 !important;
	background-color: rgba(0, 0, 0, 0.5) !important;
}

#draftModalContent {
	padding: 1rem;
}

#draftModal .bg-white {
	position: relative;
	z-index: 10000;
}

/* Ensure buttons are visible and properly spaced */
#draftModal .flex-col {
	gap: 0.75rem;
}

#draftModal .flex-row {
	gap: 0.75rem;
}

#draftModal button {
	min-width: fit-content;
	white-space: nowrap;
	flex-shrink: 1;
}

/* Ensure modal doesn't overflow */
#draftModal .bg-white {
	max-width: 28rem;
	width: 100%;
	margin: 0 auto;
}

/* Force yellow button styling */
#draftModal #saveDraftBtn {
	background-color: #eab308 !important;
	color: white !important;
	border: none !important;
}

#draftModal #saveDraftBtn:hover {
	background-color: #ca8a04 !important;
}

/* Improve modal appearance */
#draftModal .bg-white {
	border-radius: 0.75rem;
	box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

#draftModal h3 {
	font-weight: 600;
	color: #1e293b;
}

#draftModal p {
	line-height: 1.6;
	color: #64748b;
}
</style>
{% endblock %}
