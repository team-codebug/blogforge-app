{% extends 'layout.html' %}
{% block title %}{{ 'Edit Post ¬∑ BlogForge' if post else 'New Post ¬∑ BlogForge' }}{% endblock %}
{% block content %}
<div class='flex flex-col gap-4'>
	<div class='flex items-center justify-between'>
		<h1 class='text-xl md:text-2xl font-semibold'>{{ 'Edit Post' if post else 'New Post' }}</h1>
		<div class='flex items-center gap-2'>
			<button type='button' id='aiLinkedIn' class='px-3 py-2 rounded-md bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-soft hover:shadow-lg transition'>‚ú® Repurpose to LinkedIn</button>
			<button type='button' id='aiTwitter' class='px-3 py-2 rounded-md border border-purple-600/40 text-purple-700 dark:text-purple-300 hover:bg-purple-50 dark:hover:bg-purple-950/20 transition'>üê¶ Generate Tweet Thread</button>
			<button type='button' id='aiSummary' class='px-3 py-2 rounded-md border border-indigo-600/40 text-indigo-700 dark:text-indigo-300 hover:bg-indigo-50 dark:hover:bg-indigo-950/20 transition'>üß† Summarize</button>
		</div>
	</div>
	<form method='post' action='{{ url_for('posts.update_post', post_id=post.id) if post else url_for('posts.create_post') }}' class='space-y-4' data-post-id='{{ post.id if post else "" }}'>
		<input type='hidden' name='csrf_token' value='{{ csrf_token() }}'>
		<input type='text' name='title' value='{{ post.title if post else '' }}' placeholder='Post title' class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft outline-none focus:ring-2 focus:ring-purple-600/30'>
		
		<!-- Description Field -->
		<div class='space-y-2'>
			<div class='flex items-center justify-between'>
				<label class='text-sm font-medium text-slate-700 dark:text-slate-300'>Description</label>
				<div class='flex items-center gap-2'>
					<span id='descriptionWordCount' class='text-xs text-slate-500'>0/50 words</span>
					<button type='button' id='generateDescription' class='px-3 py-1 text-xs rounded-md bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:shadow-lg transition'>‚ú® Generate with AI</button>
				</div>
			</div>
			<textarea id='descriptionInput' name='description' rows='2' maxlength='500' placeholder='Brief description of your blog post (max 50 words)...' class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft outline-none focus:ring-2 focus:ring-indigo-600/30 text-sm resize-none'>{{ post.description if post else '' }}</textarea>
		</div>
		
		<!-- Tag Selection (only show when editing existing post) -->
		{% if post and available_tags %}
		<div class='space-y-2'>
			<label class='text-sm font-medium text-slate-700 dark:text-slate-300'>Tags</label>
			<div class='flex flex-wrap gap-2'>
				{% for tag in available_tags %}
				<label class='flex items-center gap-2 px-3 py-1 rounded-full border border-slate-300 dark:border-slate-600 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors'>
					<input type='checkbox' name='tags' value='{{ tag.id }}' 
						   {% if tag.id in current_tag_ids %}checked{% endif %}
						   class='rounded border-slate-300 text-orange-600 focus:ring-orange-500'>
					<span class='text-sm text-slate-700 dark:text-slate-300'>{{ tag.name }}</span>
				</label>
				{% endfor %}
			</div>
			{% if not available_tags %}
			<p class='text-sm text-slate-500'>No tags available. <a href='{{ url_for('posts.list_tags') }}' class='text-orange-600 hover:text-orange-700'>Create some tags first</a>.</p>
			{% endif %}
		</div>
		{% endif %}
		
		<div class='grid grid-cols-1 lg:grid-cols-2 gap-4'>
			<div class='space-y-2'>
				<div class='flex items-center justify-between'>
					<label class='text-sm font-medium text-slate-700'>Editor</label>
					<div class='flex items-center gap-2 text-xs text-slate-500'>
						<span id='wordCount'>0 words</span>
						<span id='saveStatus' class='text-green-600'>Saved</span>
					</div>
				</div>
				<textarea id='mdInput' name='content' rows='22' class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft outline-none focus:ring-2 focus:ring-indigo-600/30 font-mono text-sm' placeholder='Write markdown here...'>{{ post.content_markdown if post else '' }}</textarea>
			</div>
			<div class='space-y-2'>
				<div class='flex items-center justify-between'>
					<label class='text-sm font-medium text-slate-700'>Preview</label>
					<button type='button' id='togglePreview' class='text-xs text-slate-500 hover:text-slate-700'>Fullscreen</button>
				</div>
			<div class='w-full border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft min-h-[400px] overflow-y-auto'>
				<article id='mdPreview' class='prose max-w-none'></article>
			</div>
			</div>
		</div>
		<div class='flex items-center gap-2'>
			<button class='px-4 py-2 rounded-md bg-slate-900 text-white dark:bg-white dark:text-slate-900'>Save</button>
			<button type='button' id='cancelButton' class='px-4 py-2 rounded-md border border-slate-300 dark:border-slate-700'>Cancel</button>
		</div>
	</form>
	<!-- AI Output Drawer -->
	<div id='aiOutput' class='hidden border border-slate-200 dark:border-slate-800 rounded-lg p-3 bg-white dark:bg-slate-900 shadow-soft'>
		<div class='text-slate-500 text-sm mb-2'>AI Output</div>
		<pre class='whitespace-pre-wrap text-sm' id='aiOutputContent'></pre>
	</div>
</div>

<!-- Draft Confirmation Modal -->
<div id='draftModal' class='fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center p-4' style='position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important;'>
	<div class='bg-white rounded-lg max-w-sm w-full shadow-2xl'>
		<div id="draftModalContent" class='p-8'>
			<div class='flex items-center gap-4 mb-6'>
				<div class='w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center'>
					<svg class='w-5 h-5 text-yellow-600' fill='currentColor' viewBox='0 0 20 20'>
						<path fill-rule='evenodd' d='M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z' clip-rule='evenodd'/>
					</svg>
				</div>
				<h3 class='text-xl font-semibold text-slate-800'>Save as Draft?</h3>
			</div>
			<p class='text-slate-600 mb-8 text-base leading-relaxed'>You have unsaved changes. Would you like to save this post as a draft before leaving?</p>
			<div class='flex flex-col sm:flex-row gap-3 justify-end'>
				<button id='continueEditingBtn' class='px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors text-sm'>
					Continue Editing
				</button>
				<button id='discardChangesBtn' class='px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors text-sm'>
					Discard Changes
				</button>
				<button id='saveDraftBtn' class='px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors text-sm font-medium'>
					Save as Draft
				</button>
			</div>
		</div>
	</div>
</div>

<script src='{{ url_for('static', filename='js/editor.js') }}'></script>
<script>
	window.addEventListener('DOMContentLoaded', function(){
		const mdIn = document.getElementById('mdInput');
		const mdPrev = document.getElementById('mdPreview');
		function render() {
			// naive markdown preview for now; replace with server/client renderer later
			const txt = mdIn.value;
			mdPrev.innerHTML = txt
				.replace(/\n\n/g, '<br/><br/>')
				.replace(/^# (.*$)/gim, '<h1>$1</h1>')
				.replace(/^## (.*$)/gim, '<h2>$1</h2>')
				.replace(/^### (.*$)/gim, '<h3>$1</h3>')
				.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
				.replace(/\*(.*?)\*/g, '<em>$1</em>');
		}
		mdIn.addEventListener('input', render);
		render();

		const out = document.getElementById('aiOutput');
		const outC = document.getElementById('aiOutputContent');
		async function call(path) {
			out.classList.remove('hidden');
			outC.textContent = 'Working...';
			try {
				const res = await fetch(path, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({ post_id: {{ post.id if post else 'null' }} })
				});
				const data = await res.json();
				outC.textContent = JSON.stringify(data, null, 2);
			} catch (e) {
				outC.textContent = 'Error calling AI service';
			}
		}
		document.getElementById('aiLinkedIn').addEventListener('click', function(){ call('/api/ai/blog-to-linkedin'); });
		document.getElementById('aiTwitter').addEventListener('click', function(){ call('/api/ai/blog-to-twitter-thread'); });
		document.getElementById('aiSummary').addEventListener('click', function(){ call('/api/ai/summarize'); });
		
		// Description functionality
		const descInput = document.getElementById('descriptionInput');
		const descWordCount = document.getElementById('descriptionWordCount');
		const generateDescBtn = document.getElementById('generateDescription');
		
		function updateDescriptionWordCount() {
			const text = descInput.value;
			const words = text.trim() ? text.trim().split(/\s+/).length : 0;
			descWordCount.textContent = `${words}/50 words`;
			descWordCount.className = words > 50 ? 'text-xs text-red-500' : 'text-xs text-slate-500';
		}
		
		descInput.addEventListener('input', updateDescriptionWordCount);
		updateDescriptionWordCount();
		
		generateDescBtn.addEventListener('click', async function() {
			const title = document.querySelector('input[name="title"]').value;
			const content = mdIn.value;
			
			if (!title && !content) {
				alert('Please add a title or content before generating description');
				return;
			}
			
			generateDescBtn.textContent = 'Generating...';
			generateDescBtn.disabled = true;
			
			try {
				const response = await fetch('/api/ai/generate-description', {
					method: 'POST',
					headers: { 
						'Content-Type': 'application/json',
						'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
					},
					body: JSON.stringify({ 
						title: title,
						content: content
					})
				});
				
				const data = await response.json();
				if (data.description) {
					descInput.value = data.description;
					updateDescriptionWordCount();
				} else {
					alert('Failed to generate description');
				}
			} catch (error) {
				console.error('Error generating description:', error);
				alert('Error generating description');
			} finally {
				generateDescBtn.textContent = '‚ú® Generate with AI';
				generateDescBtn.disabled = false;
			}
		});
		
		// Tag selection enhancement
		const tagCheckboxes = document.querySelectorAll('input[name="tags"]');
		tagCheckboxes.forEach(checkbox => {
			checkbox.addEventListener('change', function() {
				const label = this.closest('label');
				if (this.checked) {
					label.classList.add('bg-orange-100', 'border-orange-400', 'dark:bg-orange-900/20', 'dark:border-orange-500');
					label.classList.remove('hover:bg-slate-50', 'dark:hover:bg-slate-800');
				} else {
					label.classList.remove('bg-orange-100', 'border-orange-400', 'dark:bg-orange-900/20', 'dark:border-orange-500');
					label.classList.add('hover:bg-slate-50', 'dark:hover:bg-slate-800');
				}
			});
			
			// Initialize visual state
			if (checkbox.checked) {
				const label = checkbox.closest('label');
				label.classList.add('bg-orange-100', 'border-orange-400', 'dark:bg-orange-900/20', 'dark:border-orange-500');
				label.classList.remove('hover:bg-slate-50', 'dark:hover:bg-slate-800');
			}
		});
		
		// Draft modal functionality
		const cancelButton = document.getElementById('cancelButton');
		const draftModal = document.getElementById('draftModal');
		const saveDraftBtn = document.getElementById('saveDraftBtn');
		const discardChangesBtn = document.getElementById('discardChangesBtn');
		const continueEditingBtn = document.getElementById('continueEditingBtn');
		
		// Check if we're creating a new post (not editing existing)
		const isNewPost = !document.querySelector('form[data-post-id]').getAttribute('data-post-id');
		
		cancelButton.addEventListener('click', function() {
			if (isNewPost) {
				// Show draft modal for new posts
				draftModal.classList.remove('hidden');
			} else {
				// For existing posts, just redirect
				window.location.href = '{{ url_for('posts.list_posts') }}';
			}
		});
		
		// Save as draft
		saveDraftBtn.addEventListener('click', async function() {
			const title = document.querySelector('input[name="title"]').value;
			const description = document.querySelector('textarea[name="description"]').value;
			const content = mdIn.value;
			
			if (!title.trim()) {
				alert('Please enter a title before saving as draft');
				return;
			}
			
			try {
				const response = await fetch('/posts/save-draft', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
					},
					body: JSON.stringify({
						title: title,
						description: description,
						content: content
					})
				});
				
				const data = await response.json();
				if (data.success) {
					window.location.href = '{{ url_for('posts.list_posts') }}';
				} else {
					alert('Failed to save draft: ' + data.error);
				}
			} catch (error) {
				console.error('Error saving draft:', error);
				alert('Error saving draft');
			}
		});
		
		// Discard changes
		discardChangesBtn.addEventListener('click', function() {
			window.location.href = '{{ url_for('posts.list_posts') }}';
		});
		
		// Continue editing
		continueEditingBtn.addEventListener('click', function() {
			draftModal.classList.add('hidden');
		});
	});
</script>

<style>
/* Ensure draft modal appears above everything */
#draftModal {
	position: fixed !important;
	top: 0 !important;
	left: 0 !important;
	width: 100vw !important;
	height: 100vh !important;
	z-index: 9999 !important;
	background-color: rgba(0, 0, 0, 0.5) !important;
}

#draftModalContent {
	padding: 1rem;
}

#draftModal .bg-white {
	position: relative;
	z-index: 10000;
}

/* Ensure buttons are visible and properly spaced */
#draftModal .flex-col {
	gap: 0.75rem;
}

#draftModal .flex-row {
	gap: 0.75rem;
}

#draftModal button {
	min-width: fit-content;
	white-space: nowrap;
	flex-shrink: 1;
}

/* Ensure modal doesn't overflow */
#draftModal .bg-white {
	max-width: 28rem;
	width: 100%;
	margin: 0 auto;
}

/* Force yellow button styling */
#draftModal #saveDraftBtn {
	background-color: #eab308 !important;
	color: white !important;
	border: none !important;
}

#draftModal #saveDraftBtn:hover {
	background-color: #ca8a04 !important;
}

/* Improve modal appearance */
#draftModal .bg-white {
	border-radius: 0.75rem;
	box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

#draftModal h3 {
	font-weight: 600;
	color: #1e293b;
}

#draftModal p {
	line-height: 1.6;
	color: #64748b;
}
</style>
{% endblock %}
