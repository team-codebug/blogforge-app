{% extends 'layout.html' %}
{% block content %}
<div class='max-w-6xl mx-auto space-y-6 bg-white min-h-screen p-6'>
	<div class='flex justify-between items-center mb-6'>
		<div>
			<h1 class='text-2xl font-bold text-slate-800'>Feed</h1>
			<p class='text-slate-600'>Discover amazing blogs from the community</p>
		</div>
	</div>
	
	<!-- Search Results Info -->
	{% if search_query %}
	<div class='mb-4 p-4 bg-orange-50 dark:bg-orange-950/20 border border-orange-200 dark:border-orange-800 rounded-lg'>
		<div class='flex items-center justify-between'>
			<div class='flex items-center gap-2'>
				<svg class='w-5 h-5 text-orange-600' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
					<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'></path>
				</svg>
				<span class='text-orange-800 dark:text-orange-200 font-medium'>
					Search results for "{{ search_query }}"
				</span>
			</div>
			<a href='{{ url_for('main.dashboard') }}' class='text-orange-600 hover:text-orange-800 dark:text-orange-400 dark:hover:text-orange-200 text-sm font-medium'>
				Clear search
			</a>
		</div>
		<p class='text-orange-700 dark:text-orange-300 text-sm mt-1'>
			Found {{ blogs|length }} blog{{ 's' if blogs|length != 1 else '' }} matching your search
		</p>
	</div>
	{% endif %}
	
	{% if blogs %}
	<div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'>
		{% for blog in blogs %}
		<div class='bg-white rounded-lg border border-slate-200 shadow-soft hover:shadow-md transition-shadow cursor-pointer blog-card' data-blog-id='{{ blog.id }}'>
			<div class='p-6'>
				<!-- Post Title -->
				<h3 class='text-lg font-semibold text-slate-800 mb-2 line-clamp-2'>
					{{ blog.title }}
				</h3>
				
				<!-- Post Description -->
				{% if blog.description %}
				<p class='text-sm text-slate-600 mb-4 line-clamp-3'>{{ blog.description }}</p>
				{% endif %}
				
				<!-- Tags -->
				{% if blog.tags %}
				<div class='flex flex-wrap gap-2 mb-4'>
					{% for tag in blog.tags %}
					<span class='tag-color text-xs text-white {{ tag_colors[loop.index0 % tag_colors|length] }}'>
						{{ tag.name }}
					</span>
					{% endfor %}
				</div>
				{% endif %}
				
				<!-- Author and Post Meta -->
				<div class='flex items-center justify-between text-xs text-slate-500'>
					<div class='flex items-center gap-2'>
						{% if blog.user.avatar_url %}
						<img src='{{ blog.user.avatar_url }}' alt='{{ blog.user.name }}' class='w-6 h-6 rounded-full'>
						{% else %}
						<div class='w-6 h-6 bg-slate-300 rounded-full flex items-center justify-center'>
							<svg class='w-3 h-3 text-slate-600' fill='currentColor' viewBox='0 0 20 20'>
								<path fill-rule='evenodd' d='M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z' clip-rule='evenodd'/>
							</svg>
						</div>
						{% endif %}
						<span class='font-medium'>{{ blog.user.name }}</span>
					</div>
					<span>{{ blog.created_at.strftime('%b %d, %Y') }}</span>
				</div>
			</div>
		</div>
		{% endfor %}
	</div>
	{% else %}
	<div class='text-center py-12'>
		<div class='w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4'>
			{% if search_query %}
			<svg class='w-8 h-8 text-slate-400' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
				<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'></path>
			</svg>
			{% else %}
			<svg class='w-8 h-8 text-slate-400' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
				<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z'></path>
			</svg>
			{% endif %}
		</div>
		{% if search_query %}
		<h3 class='text-lg font-medium text-slate-600 mb-2'>No results found</h3>
		<p class='text-slate-500 mb-4'>No blogs match your search for "{{ search_query }}". Try different keywords or browse all posts.</p>
		<div class='flex flex-col sm:flex-row gap-3 justify-center'>
			<a href='{{ url_for('main.dashboard') }}' class='inline-flex items-center px-4 py-2 bg-slate-500 text-white rounded-lg hover:bg-slate-600 transition-colors'>
				<svg class='w-4 h-4 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
					<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 6h16M4 10h16M4 14h16M4 18h16'></path>
				</svg>
				Browse All Posts
			</a>
			<a href='{{ url_for('posts.new_blog') }}' class='inline-flex items-center px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors'>
				<svg class='w-4 h-4 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
					<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 4v16m8-8H4'></path>
				</svg>
				Create a Post
			</a>
		</div>
		{% else %}
		<h3 class='text-lg font-medium text-slate-600 mb-2'>No published blogs yet</h3>
		<p class='text-slate-500 mb-4'>Be the first to publish a blog post!</p>
		<a href='{{ url_for('posts.new_blog') }}' class='inline-flex items-center px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors'>
			<svg class='w-4 h-4 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
				<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 4v16m8-8H4'></path>
			</svg>
			Create Your First Post
		</a>
		{% endif %}
	</div>
	{% endif %}
</div>

<!-- Blog Overlay Modal -->
<div id='blogOverlay' class='fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center p-4' style='position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important;'>
	<div id="blogOverlayContent" class='bg-white rounded-xl max-w-5xl w-full max-h-[95vh] overflow-hidden shadow-2xl border border-slate-200'>
		<!-- Overlay Header -->
		<div class='flex items-center justify-between p-8 border-b border-slate-200 bg-slate-50'>
			<div class='flex items-center gap-4'>
				<div id='overlayAuthorAvatar' class='w-12 h-12 bg-slate-300 rounded-full flex items-center justify-center'>
					<svg class='w-6 h-6 text-slate-600' fill='currentColor' viewBox='0 0 20 20'>
						<path fill-rule='evenodd' d='M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z' clip-rule='evenodd'/>
					</svg>
				</div>
				<div>
					<h2 id='overlayTitle' class='text-2xl font-bold text-slate-800 mb-1'></h2>
					<p id='overlayAuthor' class='text-sm text-slate-600 font-medium'></p>
				</div>
			</div>
			<button id='closeOverlay' class='p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-full transition-colors'>
				<svg class='w-6 h-6' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
					<path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 18L18 6M6 6l12 12'></path>
				</svg>
			</button>
		</div>
		
	<!-- Overlay Content -->
	<div class='flex flex-col h-[calc(95vh-140px)]'>
		<!-- Description and Tags Section -->
		<div class='px-8 py-6 border-b border-slate-200 bg-slate-50 flex-shrink-0'>
			<div id='overlayDescription' class='text-slate-600 text-lg leading-relaxed mb-4'></div>
			<div id='overlayTags' class='flex flex-wrap gap-2'></div>
		</div>
		
		<!-- Scrollable Content Area -->
		<div class='flex-1 overflow-y-auto bg-white' style='height: 0; min-height: 0;'>
			<div class='px-8 py-8'>
				<div id='overlayContent' class='prose prose-lg max-w-none prose-slate prose-headings:text-slate-800 prose-p:text-slate-700 prose-strong:text-slate-800 prose-a:text-orange-600 prose-a:no-underline hover:prose-a:underline prose-headings:mb-4 prose-headings:mt-6 prose-p:mb-4 prose-ul:mb-4 prose-ol:mb-4 prose-li:mb-2'></div>
			</div>
		</div>
	</div>
	</div>
</div>

<style>
.line-clamp-2 {
	display: -webkit-box;
	-webkit-line-clamp: 2;
	-webkit-box-orient: vertical;
	overflow: hidden;
}

.line-clamp-3 {
	display: -webkit-box;
	-webkit-line-clamp: 3;
	-webkit-box-orient: vertical;
	overflow: hidden;
}

/* Ensure tag colors are applied properly */
.tag-color {
	font-weight: 500;
	border-radius: 9999px;
	display: inline-block;
}

/* Force tag background colors */
.bg-blue-600 { background-color: #2563eb !important; }
.bg-green-600 { background-color: #16a34a !important; }
.bg-purple-600 { background-color: #9333ea !important; }
.bg-pink-600 { background-color: #db2777 !important; }
.bg-yellow-600 { background-color: #ca8a04 !important; }
.bg-indigo-600 { background-color: #4f46e5 !important; }
.bg-red-600 { background-color: #dc2626 !important; }
.bg-orange-600 { background-color: #ea580c !important; }
.bg-teal-600 { background-color: #0d9488 !important; }
.bg-cyan-600 { background-color: #0891b2 !important; }

/* Overlay positioning */
#blogOverlay {
	position: fixed !important;
	top: 0 !important;
	left: 0 !important;
	width: 100vw !important;
	height: 100vh !important;
	z-index: 9999 !important;
	background-color: rgba(0, 0, 0, 0.5) !important;
}

#blogOverlayContent {
	padding: 10px;
	margin: auto;
	overflow-y: scroll;
	overflow-x: hidden;
	-webkit-overflow-scrolling: touch;
	height: 100%;
	max-height: 100%;
	scrollbar-width: thin;
	scrollbar-color: #cbd5e1 #f1f5f9;
	scrollbar-gutter: stable;
	scrollbar-gutter: stable;
}

/* Overlay content spacing */
#blogOverlay .prose {
	margin: 0 !important;
}

#blogOverlay .prose h1,
#blogOverlay .prose h2,
#blogOverlay .prose h3,
#blogOverlay .prose h4,
#blogOverlay .prose h5,
#blogOverlay .prose h6 {
	margin-top: 1.5rem !important;
	margin-bottom: 1rem !important;
	line-height: 1.3 !important;
}

#blogOverlay .prose p {
	margin-bottom: 1rem !important;
	line-height: 1.6 !important;
}

#blogOverlay .prose ul,
#blogOverlay .prose ol {
	margin-bottom: 1rem !important;
	padding-left: 1.5rem !important;
}

#blogOverlay .prose li {
	margin-bottom: 0.5rem !important;
	line-height: 1.5 !important;
}

#blogOverlay .prose strong {
	font-weight: 600 !important;
}

#blogOverlay .prose a {
	color: #f97316 !important;
	text-decoration: none !important;
}

#blogOverlay .prose a:hover {
	text-decoration: underline !important;
}

/* Ensure proper scrolling in overlay */
#blogOverlay .overflow-y-auto {
	overflow-y: auto !important;
	-webkit-overflow-scrolling: touch !important;
	height: 100% !important;
	max-height: 100% !important;
}

/* Force flexbox behavior for scrolling */
#blogOverlay .flex-1 {
	flex: 1 1 0% !important;
	overflow: hidden !important;
}

/* Custom scrollbar for overlay */
#blogOverlay .overflow-y-auto::-webkit-scrollbar {
	width: 6px;
}

#blogOverlay .overflow-y-auto::-webkit-scrollbar-track {
	background: #f1f5f9;
	border-radius: 3px;
}

#blogOverlay .overflow-y-auto::-webkit-scrollbar-thumb {
	background: #cbd5e1;
	border-radius: 3px;
}

#blogOverlay .overflow-y-auto::-webkit-scrollbar-thumb:hover {
	background: #94a3b8;
}

/* Additional scrolling fixes */
#blogOverlay .flex {
	display: flex !important;
}

#blogOverlay .flex-col {
	flex-direction: column !important;
}

#blogOverlay .flex-shrink-0 {
	flex-shrink: 0 !important;
}

/* Ensure the scrollable area takes available space */
#blogOverlay .overflow-y-auto {
	overflow-y: auto !important;
	overflow-x: hidden !important;
	-webkit-overflow-scrolling: touch !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
	const blogCards = document.querySelectorAll('.blog-card');
	const overlay = document.getElementById('blogOverlay');
	const closeOverlay = document.getElementById('closeOverlay');
	
	console.log('Blog cards found:', blogCards.length);
	console.log('Overlay element:', overlay);
	console.log('Close overlay element:', closeOverlay);
	
	// Tag colors for overlay
	const tagColors = [
		'bg-blue-600 text-white',
		'bg-green-600 text-white',
		'bg-purple-600 text-white',
		'bg-pink-600 text-white',
		'bg-yellow-600 text-white',
		'bg-indigo-600 text-white',
		'bg-red-600 text-white',
		'bg-orange-600 text-white',
		'bg-teal-600 text-white',
		'bg-cyan-600 text-white'
	];
	
	// Open overlay when blog card is clicked
	blogCards.forEach(card => {
		card.addEventListener('click', async function(e) {
			e.preventDefault();
			e.stopPropagation();
			
			const blogId = this.getAttribute('data-blog-id');
			console.log('Blog card clicked, blog ID:', blogId);
			
			try {
				// Show loading state
				console.log('Showing overlay...');
				overlay.classList.remove('hidden');
				overlay.style.display = 'flex';
				overlay.style.position = 'fixed';
				overlay.style.top = '0';
				overlay.style.left = '0';
				overlay.style.width = '100vw';
				overlay.style.height = '100vh';
				overlay.style.zIndex = '9999';
				overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
				document.getElementById('overlayTitle').textContent = 'Loading...';
				document.getElementById('overlayContent').innerHTML = '<p class="text-slate-500">Loading blog content...</p>';
				
				// Fetch blog content
				const response = await fetch(`/api/blog/${blogId}`);
				const blog = await response.json();
				
				if (response.ok) {
					// Populate overlay content
					document.getElementById('overlayTitle').textContent = blog.title;
					document.getElementById('overlayAuthor').textContent = `By ${blog.author.name}`;
					document.getElementById('overlayDescription').textContent = blog.description || '';
					
					// Set author avatar
					const authorAvatar = document.getElementById('overlayAuthorAvatar');
					if (blog.author.avatar_url) {
						authorAvatar.innerHTML = `<img src="${blog.author.avatar_url}" alt="${blog.author.name}" class="w-10 h-10 rounded-full object-cover">`;
					}
					
					// Render tags
					const tagsContainer = document.getElementById('overlayTags');
					tagsContainer.innerHTML = '';
					blog.tags.forEach((tag, index) => {
						const tagElement = document.createElement('span');
						tagElement.className = `tag-color text-sm text-white px-4 py-2 rounded-full font-medium ${tagColors[index % tagColors.length]}`;
						tagElement.textContent = tag.name;
						tagsContainer.appendChild(tagElement);
					});
					
					// Render markdown content
					await renderMarkdownContent(blog.content);
					
				} else {
					document.getElementById('overlayTitle').textContent = 'Error';
					document.getElementById('overlayContent').innerHTML = '<p class="text-red-500">Failed to load blog content.</p>';
				}
			} catch (error) {
				console.error('Error loading blog:', error);
				document.getElementById('overlayTitle').textContent = 'Error';
				document.getElementById('overlayContent').innerHTML = '<p class="text-red-500">Failed to load blog content.</p>';
			}
		});
	});
	
	// Close overlay
	closeOverlay.addEventListener('click', function() {
		console.log('Closing overlay...');
		overlay.classList.add('hidden');
		overlay.style.display = 'none';
	});
	
	// Close overlay when clicking outside
	overlay.addEventListener('click', function(e) {
		if (e.target === overlay) {
			console.log('Closing overlay by clicking outside...');
			overlay.classList.add('hidden');
			overlay.style.display = 'none';
		}
	});
	
	// Render markdown content
	async function renderMarkdownContent(markdown) {
		try {
			const encodedText = encodeURIComponent(markdown);
			const response = await fetch(`/posts/render-markdown?text=${encodedText}`, {
				method: 'GET',
				headers: {
					'X-Requested-With': 'XMLHttpRequest'
				}
			});
			
			if (response.ok) {
				const data = await response.json();
				document.getElementById('overlayContent').innerHTML = data.html;
			} else {
				// Fallback to simple text display
				document.getElementById('overlayContent').innerHTML = `<p class="text-slate-600">${markdown.replace(/\n/g, '<br>')}</p>`;
			}
		} catch (error) {
			console.error('Error rendering markdown:', error);
			document.getElementById('overlayContent').innerHTML = `<p class="text-slate-600">${markdown.replace(/\n/g, '<br>')}</p>`;
		}
	}
	
});
</script>
{% endblock %}
